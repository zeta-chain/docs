---
title: è·¨é“¾æ¶ˆæ¯
---

æœ¬æ•™ç¨‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ ZetaChain çš„æ¶ˆæ¯åŸºç¡€è®¾æ–½ï¼Œåœ¨ä¸¤æ¡ EVM é“¾ä¸Šçš„åˆçº¦é—´å‘é€è·¨é“¾æ¶ˆæ¯ã€‚

ä¸éƒ¨ç½²åœ¨ ZetaChain ä¸Šçš„å…¨é“¾åº”ç”¨ä¸åŒï¼Œæ­¤æ¨¡å¼å…è®¸ä½ å°†æ‰€æœ‰åˆçº¦é€»è¾‘ç•™åœ¨å·²æœ‰çš„è¿æ¥ EVM é“¾ä¸Šã€‚ZetaChain ä»…è´Ÿè´£åœ¨å®ƒä»¬ä¹‹é—´è·¯ç”±æ¶ˆæ¯ï¼Œæ— éœ€åœ¨ ZetaChain éƒ¨ç½²ä»»ä½•åˆçº¦ã€‚

> ä¸ºä»€ä¹ˆä½¿ç”¨è¯¥æ¨¡å¼ï¼Ÿç›¸æ¯”ç›´æ¥åœ¨ ZetaChain éƒ¨ç½²å…¨é“¾åº”ç”¨ï¼Œæ­¤æ–¹å¼å¯è®©å…¨éƒ¨ä¸šåŠ¡é€»è¾‘ä¿ç•™åœ¨ä½ ç†Ÿæ‚‰çš„è¿æ¥ EVM é“¾ä¸Šã€‚ZetaChain åªè´Ÿè´£ä¼ è¾“è½½è·ï¼Œå¹¶ä¸éƒ¨ç½²åˆçº¦ä»£ç ã€‚

å®Œæˆæœ¬æ•™ç¨‹åï¼Œä½ å°†ï¼š

- åœ¨ä¸¤ä¸ª EVM æµ‹è¯•ç½‘ï¼ˆBase ä¸ Ethereum Sepoliaï¼‰éƒ¨ç½²æ¶ˆæ¯ä¼ é€’åˆçº¦
- å»ºç«‹å®ƒä»¬ä¹‹é—´çš„è·¨é“¾é€šä¿¡
- ä»ä¸€æ¡é“¾å‘å¦ä¸€æ¡é“¾å‘é€æ¶ˆæ¯ä¸ä»£å¸æ•°é‡
- è·Ÿè¸ªè·¨é“¾äº¤æ˜“ä»æºé“¾åˆ°ç›®æ ‡é“¾çš„çŠ¶æ€

<div className="mt-8" style={{ width: "100%", height: "auto", aspectRatio: "16 / 9" }}>
  <iframe
    width="100%"
    height="100%"
    src="https://www.youtube.com/embed/UrAMdR807JQ"
    title="YouTube video player"
    frameBorder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
    allowFullScreen
  ></iframe>
</div>

## åˆ›å»ºé¡¹ç›®

ä½¿ç”¨ `messaging` æ¨¡æ¿åˆ›å»ºæ–°é¡¹ç›®ï¼š

```
npx zetachain new --project messaging
```

å®‰è£… TypeScript ä¸ Foundry ä¾èµ–ï¼š

```
cd messaging
yarn
forge soldeer update
```

ç¼–è¯‘åˆçº¦ï¼š

```
forge build
```

ä¸ºäº†è®©è„šæœ¬è¯»å–ï¼Œå»ºè®®å°†ç§é’¥ä¿å­˜ä¸ºç¯å¢ƒå˜é‡ï¼š

```
PRIVATE_KEY=...
```

## Messaging åˆçº¦

è¦å¯ç”¨è·¨é“¾æ¶ˆæ¯ä¼ é€’ï¼Œåˆçº¦éœ€ç»§æ‰¿ ZetaChain çš„ `Messaging` åŸºç±»å¹¶å®ç°å¿…è¦å‡½æ•°ã€‚

ä» ZetaChain æ ‡å‡†åˆçº¦åŒ…å¼•å…¥ `Messaging.sol`ï¼š

```solidity
import "@zetachain/standard-contracts/contracts/messaging/contracts/Messaging.sol";
```

åœ¨åˆçº¦ä¸­ç»§æ‰¿ `Messaging`ï¼š

```solidity
contract Example is Messaging { ... }
```

åœ¨æ„é€ å‡½æ•°ä¸­æŒ‰è¦æ±‚åˆå§‹åŒ–å‚æ•°ï¼š

```solidity
constructor(
    address payable _gateway,
    address owner,
    address _router
) Messaging(_gateway, owner, _router) {}
```

`Messaging` åŸºç±»ä¼šæä¾›å¯¹ Gateway ä¸ Router çš„è®¿é—®ï¼Œå¹¶ç¡®ä¿åˆçº¦æ­£ç¡®æ¥å…¥ ZetaChain çš„è·¨é“¾æ¶ˆæ¯ç³»ç»Ÿã€‚

ä½ éœ€è¦å®ç°ä¸‰ä¸ªæ ¸å¿ƒå†…éƒ¨å‡½æ•°ï¼Œç”¨äºå¤„ç†æ¶ˆæ¯æŠ•é€’ä¸å›é€€ï¼š

#### onMessageReceive

å½“è·¨é“¾æ¶ˆæ¯æˆåŠŸåˆ°è¾¾ç›®æ ‡é“¾æ—¶ä¼šè‡ªåŠ¨è§¦å‘ï¼š

```solidity
function onMessageReceive(
    bytes memory data,
    bytes memory sender,
    uint256 amount,
    bytes memory asset
) internal override {
    //...
}
```

åœ¨æ­¤è§£ç æ¶ˆæ¯ï¼Œæ‰§è¡ŒçŠ¶æ€æ›´æ–°ã€è§¦å‘ä¸‹æ¸¸è°ƒç”¨æˆ–å¤„ç†æ¥æ”¶åˆ°çš„ä»£å¸ã€‚

#### onMessageRevert

å½“ç›®æ ‡åˆçº¦çš„ `onMessageReceive` æ‰§è¡Œå¤±è´¥ï¼ˆå¦‚ calldata æ— æ•ˆæˆ–é€»è¾‘å›é€€ï¼‰æ—¶è§¦å‘ï¼š

```solidity
function onMessageRevert(
    bytes memory data,
    bytes memory sender,
    uint256 amount,
    bytes memory asset
) internal override {
    //...
}
```

#### onRevert

å½“æ¶ˆæ¯åœ¨è·¯ç”±è¿‡ç¨‹ä¸­æœªæŠµè¾¾ç›®æ ‡é“¾æ—¶è§¦å‘ï¼Œæ‰§è¡Œäºæºé“¾ï¼š

```solidity
function onRevert(RevertContext calldata context)
    external
    payable
    override
    onlyGateway
{
    if (context.sender != router) revert Unauthorized();
    //...
}
```

å¯åœ¨æ­¤æ‰§è¡Œé€€æ¬¾ã€è¡¥å¿é€»è¾‘æˆ–å‘å‡ºé€šçŸ¥ã€‚

### å‘é€æ¶ˆæ¯

è¦å‘èµ·è·¨é“¾æ¶ˆæ¯ï¼Œåˆçº¦éœ€è°ƒç”¨ EVM Gateway çš„ `depositAndCall`ï¼Œè¯¥å‡½æ•°ä¼šå°†æ¶ˆæ¯ä¸å¯é€‰ä»£å¸äº¤ç»™ ZetaChain çš„æ¶ˆæ¯å±‚è¿›è¡Œè·¯ç”±ã€‚

æ ¹æ®æ˜¯å¦å‘é€åŸç”Ÿ Gasï¼ˆå¦‚ ETHï¼‰æˆ– ERC-20ï¼Œæœ‰ä¸¤ç§å½¢å¼ï¼š

å‘é€å¸¦ ETH çš„æ¶ˆæ¯ï¼š

```solidity
gateway.depositAndCall{value: msg.value}(
    router,
    message,
    revertOptions
);
```

å‘é€å—æ”¯æŒçš„ ERC-20ï¼š

```solidity
gateway.depositAndCall(
    router,
    amount,
    asset,
    message,
    revertOptions
);
```

å…¶ä¸­ `asset` ä¸ºè¦å‘é€çš„ ERC-20 åœ°å€ï¼Œå¿…é¡»å·²è¢« ZetaChain æ”¯æŒã€‚

### æ¶ˆæ¯è½½è·ç»“æ„

`message` å‚æ•°æ˜¯å•ä¸ª `bytes`ï¼Œéœ€æŒ‰ Universal Router å¯è¯†åˆ«çš„ç»“æ„è¿›è¡Œ ABI ç¼–ç ï¼š

```solidity
abi.encode(
    receiver,       // bytesï¼šç›®æ ‡é“¾åˆçº¦åœ°å€
    targetToken,    // addressï¼šç›®æ ‡é“¾éœ€æ¥æ”¶çš„ä»£å¸å¯¹åº”çš„ ZRC-20
    data,           // bytesï¼šæ¶ˆæ¯è½½è·ï¼ˆå¦‚ ABI ç¼–ç çš„ "hello"ï¼‰
    gasLimit,       // uint256ï¼šç›®æ ‡é“¾æ‰§è¡Œæ‰€éœ€ Gas
    revertOptions   // structï¼šå¤±è´¥æ—¶çš„å›é€€ç­–ç•¥
)
```

ä¾‹å¦‚å°†å­—ç¬¦ä¸² `"hello"` å‘é€åˆ° Ethereum Sepolia çš„åˆçº¦ï¼š

```solidity
bytes memory data = abi.encode("hello");
bytes memory message = abi.encode(
    abi.encodePacked(receiver),
    targetToken,
    data,
    300_000,
    revertOptions
);
```

éšåå°† `message` ä¼ å…¥ `depositAndCall()`ï¼Œç»è¿‡ ZetaChain è·¯ç”±è‡³ç›®æ ‡é“¾ï¼Œå¹¶åœ¨ç›®æ ‡åˆçº¦çš„ `onMessageReceive()` ä¸­è§£ç ä½¿ç”¨ã€‚

### Universal Router ä»‹ç»

å½“ä½ è°ƒç”¨ `gateway.depositAndCall(...)` å‘é€è·¨é“¾æ¶ˆæ¯æ—¶ï¼Œå…·ä½“çš„è·¯ç”±ä¸æ‰§è¡Œé€»è¾‘ç”± **Universal Router** åˆçº¦åœ¨ ZetaChain ä¸Šå®Œæˆã€‚å®ƒæ˜¯æ‰€æœ‰è·¨é“¾æ¶ˆæ¯çš„å…¥å£ï¼Œè´Ÿè´£ï¼š

- è§£ææºé“¾ä¼ æ¥çš„æ¶ˆæ¯è½½è·
- å°†éƒ¨åˆ†ä»£å¸æ¢æˆç›®æ ‡é“¾ Gas ä»£å¸ç”¨äºæ”¯ä»˜æ‰§è¡Œè´¹ç”¨ï¼Œå°†å‰©ä½™éƒ¨åˆ†æ¢æˆç›®æ ‡é“¾æŒ‡å®šä»£å¸äº¤ç»™ç›®æ ‡åˆçº¦
- å°†æ¶ˆæ¯ä¸ä»£å¸è½¬å‘è‡³ç›®æ ‡åˆçº¦
- åœ¨ç›®æ ‡è°ƒç”¨å¤±è´¥æ—¶è¿›è¡Œå›é€€å¤„ç†

æ‰€æœ‰ç»§æ‰¿ Messaging åŸºç±»çš„åˆçº¦å…±äº«åŒä¸€ä¸ª Universal Routerï¼Œè¿™è®©å¼€å‘ä½“éªŒæ›´ä¸€è‡´ï¼Œæ— éœ€é‡å¤å®ç°ã€‚ä½ åªéœ€ä¸“æ³¨äºç¼–ç è½½è·å¹¶è°ƒç”¨ Gatewayï¼Œå…¶ä½™ç»†èŠ‚ç”± ZetaChain ä»£åŠ³ã€‚

> ğŸ”§ è¿›é˜¶ï¼šè‹¥éœ€è¦æ›´å¤šè‡ªå®šä¹‰ï¼ˆå¦‚è°ƒæ•´ä»£å¸äº¤æ¢æ–¹å¼ã€æ”¹ç”¨è‡ªå®šä¹‰ Router æˆ–å˜æ›´æ¶ˆæ¯å¤„ç†é€»è¾‘ï¼‰ï¼Œå¯éƒ¨ç½²è‡ªå®šä¹‰ Routerï¼Œå¹¶åœ¨ Messaging æ„é€ å‡½æ•°ä¸­ä¼ å…¥å¯¹åº”åœ°å€ã€‚

## éƒ¨ç½²æ¶ˆæ¯åˆçº¦

éƒ¨ç½²åˆ° Base Sepoliaï¼š

```
MESSAGING_BASE=$(./commands/index.ts deploy --rpc https://sepolia.base.org --private-key $PRIVATE_KEY | jq -r .contractAddress)
```

éƒ¨ç½²åˆ° Ethereum Sepoliaï¼š

```
MESSAGING_ETHEREUM=$(./commands/index.ts deploy --rpc https://sepolia.drpc.org --private-key $PRIVATE_KEY | jq -r .contractAddress)
```

## äº’è”åˆçº¦

åœ¨è·¨é“¾é€šä¿¡å‰ï¼Œä¸¤ä»½åˆçº¦éœ€æ˜¾å¼å½¼æ­¤ä¿¡ä»»ï¼Œä»¥é˜²æ¶æ„åˆçº¦ä¼ªé€ è·¨é“¾æ¶ˆæ¯ã€‚æ­¤æ­¥éª¤å°†ä¸ºä¸¤ä¸ªåˆçº¦å»ºç«‹åŒå‘é“¾æ¥ã€‚

æ¯ä¸ªåˆçº¦éœ€çŸ¥æ™“ï¼š

- è¿œç¨‹åˆçº¦åœ°å€
- è¿œç¨‹é“¾ ID

é€šè¿‡åˆçº¦çš„ `setConnected()` å‡½æ•°å®Œæˆé…ç½®ã€‚ZetaChain ä»…å‘å·²ç™»è®°çš„å¯ä¿¡åˆçº¦ä¼ é€’æ¶ˆæ¯ã€‚

âš ï¸ è‹¥è·³è¿‡æ­¤æ­¥éª¤æˆ–å¡«å†™é”™è¯¯åœ°å€/é“¾ IDï¼Œç›®æ ‡é“¾ä¼šæ‹’ç»æ¶ˆæ¯ã€‚

```
./commands/index.ts connect \
  --contract $MESSAGING_BASE \
  --target-contract $MESSAGING_ETHEREUM \
  --rpc https://sepolia.base.org \
  --target-chain-id 11155111 \
  --private-key $PRIVATE_KEY
```

```
./commands/index.ts connect \
  --contract $MESSAGING_ETHEREUM \
  --target-contract $MESSAGING_BASE \
  --rpc https://sepolia.drpc.org \
  --target-chain-id 84532 \
  --private-key $PRIVATE_KEY
```

å®ŒæˆåŒå‘è¿æ¥åï¼ŒåŒæ–¹å³å¯äº’å‘æ¶ˆæ¯ã€‚

## å‘é€è·¨é“¾æ¶ˆæ¯

ä¸€åˆ‡éƒ¨ç½²å°±ç»ªåï¼Œå¯ä»ä¸€æ¡é“¾å‘å¦ä¸€æ¡é“¾å‘é€æ¶ˆæ¯ã€‚

ä»¥ä¸‹ç¤ºä¾‹å°†å­—ç¬¦ä¸² `"hello"` ä» Base Sepolia çš„åˆçº¦å‘é€è‡³ Ethereum Sepolia çš„åˆçº¦ï¼š

```
./commands/index.ts message \
  --rpc https://sepolia.base.org \
  --private-key $PRIVATE_KEY \
  --contract $MESSAGING_BASE \
  --target-contract $MESSAGING_ETHEREUM \
  --types string \
  --values hello \
  --target-token 0x05BA149A7bd6dC1F937fA9046A9e05C05f3b18b0 \
  --amount 0.005
```

| å‚æ•° | è¯´æ˜ |
| --- | --- |
| `--rpc https://sepolia.base.org` | æºé“¾ï¼ˆBase Sepoliaï¼‰çš„ RPCï¼Œäº¤æ˜“ç”±æ­¤å‘å‡º |
| `--private-key $PRIVATE_KEY` | æºé“¾ä¸Šç”¨äºç­¾åä¸æ”¯ä»˜çš„è´¦æˆ·ï¼Œéœ€æŒæœ‰å‘é€ä»£å¸ |
| `--contract $MESSAGING_BASE` | æºé“¾å·²éƒ¨ç½²çš„æ¶ˆæ¯åˆçº¦åœ°å€ |
| `--target-contract $MESSAGING_ETHEREUM` | ç›®æ ‡é“¾åˆçº¦åœ°å€ |
| `--types string` | æ¶ˆæ¯çš„ ABI ç±»å‹ï¼Œå¯ä¸ºå•ä¸€ç±»å‹æˆ–å…ƒç»„ |
| `--values hello` | å®é™…å‘é€çš„å€¼ï¼Œå³å­—ç¬¦ä¸² `"hello"` |
| `--target-token 0x...` | ZetaChain ä¸Šä»£è¡¨ç›®æ ‡é“¾ä»£å¸çš„ ZRC-20 åœ°å€ |
| `--amount 0.005` | æ€»å‘é€æ•°é‡ï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†ç”¨äºæ”¯ä»˜ç›®æ ‡é“¾ Gasï¼Œå…¶ä½™è½¬ç»™ç›®æ ‡åˆçº¦ |

### æ•°é‡å¦‚ä½•å¤„ç†

ä½¿ç”¨ `--amount` å‘é€è·¨é“¾æ¶ˆæ¯æ—¶ï¼Œä½ ä¸ä»…è½¬ç§»ä»£å¸ï¼Œè¿˜é¢„ä»˜ç›®æ ‡é“¾çš„ Gasï¼š

1. åœ¨æºé“¾æä¾›ä»£å¸ï¼ˆå¦‚ Base ETHï¼‰ï¼Œå¯ä»¥æ˜¯åŸç”Ÿèµ„äº§æˆ–å—æ”¯æŒçš„ ERC-20ã€‚
2. é€šè¿‡ `--target-token` æŒ‡å®š ZetaChain ä¸Šä»£è¡¨ç›®æ ‡é“¾ä»£å¸çš„ ZRC-20ã€‚
3. ZetaChain ä¼šè‡ªåŠ¨ï¼š
   - å°†éƒ¨åˆ†é‡‘é¢å…‘æ¢æˆç›®æ ‡é“¾çš„ Gas ä»£å¸ï¼ˆZRC-20 å½¢å¼ï¼‰ï¼Œç”¨äºæ”¯ä»˜æ‰§è¡Œæˆæœ¬ã€‚
   - å°†å‰©ä½™é‡‘é¢å…‘æ¢æˆç›®æ ‡åˆçº¦æ‰€éœ€çš„ç›®æ ‡ä»£å¸ï¼Œå¹¶è½¬å…¥ç›®æ ‡åˆçº¦ã€‚

è¿™æ ·ä½ æ— éœ€æŒæœ‰ç›®æ ‡é“¾åŸç”Ÿä»£å¸ï¼Œå³å¯å®Œæˆè·¨é“¾è°ƒç”¨ã€‚

```json
{
  "contractAddress": "0xee2E8dfefd723e879CAa30A1DaD94046Fa3D24D4",
  "targetContract": "0x7c9BbA0630c9452F726bc15D0a73cdF769438efE",
  "targetToken": "0x05BA149A7bd6dC1F937fA9046A9e05C05f3b18b0",
  "message": "0x0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000568656c6c6f000000000000000000000000000000000000000000000000000000",
  "transactionHash": "0x939e230dd504efdf1fce31202a5980b4d0376430ddf535d080666256353c02c3",
  "amount": "0.005"
}
```

## è·Ÿè¸ªè·¨é“¾äº¤æ˜“

ä½¿ç”¨ä¸Šè¿°äº¤æ˜“å“ˆå¸ŒæŸ¥è¯¢è·¨é“¾çŠ¶æ€ï¼š

```
npx zetachain query cctx --hash 0x939e230dd504efdf1fce31202a5980b4d0376430ddf535d080666256353c02c3
```

```
84532 â†’ 7001 âœ… OutboundMined
CCTX:     0xd88d92d0b9b0a2fde416bf6383e430b51de48114b0b03e7cc34e7f8d8df15cb7
Tx Hash:  0x939e230dd504efdf1fce31202a5980b4d0376430ddf535d080666256353c02c3 (on chain 84532)
Tx Hash:  0x8c368f6a3cfc55950b5d2b0d98c63d1904a79300490ec7d1c258505f372054e3 (on chain 7001)
Sender:   0xee2E8dfefd723e879CAa30A1DaD94046Fa3D24D4
Receiver: 0x5BD35697D4a62DE429247cbBDCc5c47F70477775
Message:  ...

7001 â†’ 11155111 âœ… OutboundMined
CCTX:     0x8952c9f95dfb5673a9fbfa2196842b750f5530f4931a55088b1276599328fd64
Tx Hash:  0xd88d92d0b9b0a2fde416bf6383e430b51de48114b0b03e7cc34e7f8d8df15cb7 (on chain 7001)
Tx Hash:  0xf30e4414087e8b5c81e257e8a97ac9105dde37cbbd6bb33a1691c4a30585507e (on chain 11155111)
Sender:   0x5BD35697D4a62DE429247cbBDCc5c47F70477775
Receiver: 0x7c9BbA0630c9452F726bc15D0a73cdF769438efE
Message:  ...
```

è¿™è¡¨æ˜æ¶ˆæ¯å·²ç»ä» Base Sepolia ç»è¿‡ ZetaChain æˆåŠŸæŠµè¾¾ Ethereum Sepoliaã€‚

å¯åœ¨ Etherscan éªŒè¯ç›®æ ‡é“¾äº¤æ˜“ï¼š

https://sepolia.etherscan.io/tx/0xf30e4414087e8b5c81e257e8a97ac9105dde37cbbd6bb33a1691c4a30585507e

