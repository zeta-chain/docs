---
title: "å­å›¾ï¼šGoldsky"
---

## æ¦‚è¿°

æœ¬æ•™ç¨‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨å­å›¾ç´¢å¼•å™¨æŸ¥è¯¢å…¨é“¾åˆçº¦äº‹ä»¶æ•°æ®ã€‚ç¤ºä¾‹ä¸­æˆ‘ä»¬å°†ä½¿ç”¨ [Goldsky](https://docs.goldsky.com/) å­å›¾ã€‚

åœ¨å¼€å§‹ä¹‹å‰ï¼Œå‡è®¾ä½ å·²ç»å®Œæˆ[è·¨é“¾å…‘æ¢æ•™ç¨‹](/developers/tutorials/swap/)ã€‚å¦‚æœéœ€è¦åˆçº¦å®Œæ•´æºç ï¼Œå¯åœ¨ [`example-contracts` ä»“åº“](https://github.com/zeta-chain/example-contracts/tree/main/omnichain/swap) è·å–ã€‚

## ä¸º Swap åˆçº¦æ·»åŠ äº‹ä»¶

æ–°å¢ `SwapCompleted` äº‹ä»¶ï¼Œç”¨äºåœ¨è·¨é“¾å…‘æ¢æˆåŠŸåè§¦å‘ï¼š

```solidity {13-18,81-86}
// SPDX-License-Identifier: MIT
pragma solidity 0.8.7;

import "@zetachain/protocol-contracts/contracts/zevm/SystemContract.sol";
import "@zetachain/protocol-contracts/contracts/zevm/interfaces/zContract.sol";
import "@zetachain/toolkit/contracts/SwapHelperLib.sol";
import "@zetachain/toolkit/contracts/BytesHelperLib.sol";

contract Swap is zContract {
    SystemContract public immutable systemContract;
    uint256 constant BITCOIN = 18332;

    event SwapCompleted(
        address indexed zrc20,
        address indexed targetToken,
        uint256 amount,
        bytes recipient
    );

    constructor(address systemContractAddress) {
        systemContract = SystemContract(systemContractAddress);
    }

    modifier onlySystem() {
        require(
            msg.sender == address(systemContract),
            "Only system contract can call this function"
        );
        _;
    }

    function onCrossChainCall(
        zContext calldata context,
        address zrc20,
        uint256 amount,
        bytes calldata message
    ) external virtual override onlySystem {
        address targetTokenAddress;
        bytes memory recipientAddress;

        if (context.chainID == BITCOIN) {
            targetTokenAddress = BytesHelperLib.bytesToAddress(message, 0);
            recipientAddress = abi.encodePacked(
                BytesHelperLib.bytesToAddress(message, 20)
            );
        } else {
            (address targetToken, bytes memory recipient) = abi.decode(
                message,
                (address, bytes)
            );
            targetTokenAddress = targetToken;
            recipientAddress = recipient;
        }

        (address gasZRC20, uint256 gasFee) = IZRC20(targetTokenAddress)
            .withdrawGasFee();

        uint256 inputForGas = SwapHelperLib.swapTokensForExactTokens(
            systemContract.wZetaContractAddress(),
            systemContract.uniswapv2FactoryAddress(),
            systemContract.uniswapv2Router02Address(),
            zrc20,
            gasFee,
            gasZRC20,
            amount
        );

        uint256 outputAmount = SwapHelperLib._doSwap(
            systemContract.wZetaContractAddress(),
            systemContract.uniswapv2FactoryAddress(),
            systemContract.uniswapv2Router02Address(),
            zrc20,
            amount - inputForGas,
            targetTokenAddress,
            0
        );

        IZRC20(gasZRC20).approve(targetTokenAddress, gasFee);
        IZRC20(targetTokenAddress).withdraw(recipientAddress, outputAmount);

        emit SwapCompleted(
            zrc20,
            targetTokenAddress,
            outputAmount,
            recipientAddress
        );
    }
}
```

## ç¼–è¯‘å¹¶éƒ¨ç½²åˆçº¦

```
yarn

npx hardhat compile --force

npx hardhat deploy --network zeta_testnet
```

```
ğŸ”‘ Using account: 0x2cD3D070aE1BD365909dD859d29F387AA96911e1

ğŸš€ Successfully deployed contract on ZetaChain.
ğŸ“œ Contract address: 0x9846BBdE15B857d88DDad4e00CD76962245E1b6f
ğŸŒ Explorer: https://zetascan.com/address/0x9846BBdE15B857d88DDad4e00CD76962245E1b6f
```

## é…ç½® Goldsky

å®‰è£… [Goldsky CLI](https://docs.goldsky.com/introduction)ï¼š

```
curl https://goldsky.com | sh
```

ç„¶ååœ¨ https://app.goldsky.com [åˆ›å»ºè´¦å·](https://docs.goldsky.com/get-started/subgraphs)ï¼Œäºè®¾ç½®é¡µç”Ÿæˆ API keyï¼Œå¹¶ç™»å½• CLIï¼š

```
goldsky login
```

æŒ‰æç¤ºç²˜è´´ API keyã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º Goldsky é…ç½®æ–‡ä»¶ï¼š

```json filename="goldsky.json"
{
  "version": "1",
  "name": "swap",
  "abis": {
    "swap": {
      "path": "artifacts/contracts/Swap.sol/Swap.json"
    }
  },
  "chains": ["zetachain-testnet"],
  "instances": [
    {
      "abi": "swap",
      "address": "0x9846BBdE15B857d88DDad4e00CD76962245E1b6f",
      "chain": "zetachain-testnet",
      "startBlock": 3065396
    }
  ]
}
```

å°† `address` ä¸ `startBlock` æ›´æ–°ä¸ºä½ éƒ¨ç½²åˆçº¦æ—¶çš„å®é™…å€¼ã€‚

åˆ›å»ºå­å›¾ï¼š

```
goldsky subgraph deploy swap/v1 --from-abi goldsky.json
```

```
â—‡  Subgraph generated, deploying to your goldsky project
â”‚
â—‡  Deployed subgraph API: https://api.goldsky.com/api/public/project_clnujea22c0if34x5965c8c0j/subgraphs/swap-zetachain-testnet/v1/gn
```

## ä¸åˆçº¦äº¤äº’

å­å›¾éƒ¨ç½²å®Œæˆåï¼Œå¯æ‰§è¡Œè·¨é“¾å…‘æ¢ä¸åˆçº¦äº¤äº’ã€‚ç¤ºä¾‹ä¸­æˆ‘ä»¬å°† 5 æš tMATIC å…‘æ¢ä¸º BTCã€‚

```
npx hardhat interact --contract 0x9846BBdE15B857d88DDad4e00CD76962245E1b6f --amount 5 --network mumbai_testnet --target-token 0x65a45c57636f9BcCeD4fe193A602008578BcA90b --recipient tb1q2dr85d57450xwde6560qyhj7zvzw9895hq25tx
```

```
ğŸ”‘ Using account: 0x2cD3D070aE1BD365909dD859d29F387AA96911e1

ğŸš€ Successfully broadcasted a token transfer transaction on mumbai_testnet network.
ğŸ“ Transaction hash: 0xb4318f04329d6ddd398b11ccba40d0404e1872494a054fb382267e2f1de160e9
```

å¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤è·Ÿè¸ªäº¤æ˜“ï¼š

```
npx hardhat cctx 0xb4318f04329d6ddd398b11ccba40d0404e1872494a054fb382267e2f1de160e9
```

```
CCTXs on ZetaChain found.

âœ“ 0xf5fbf1ba190e074c64adaba044e2c4f6724aeebe70ca01b0998919d0b1059338: 80001 â†’ 7001: OutboundMined (Remote omnichain contract call completed)
â  0xa0cfd783f991bd060239193082594dd3fe5ae239e97b8baaa0a303ee6ba6ba79: 7001 â†’ 18332: PendingOutbound
```

å½“çœ‹åˆ°è·¨é“¾äº¤æ˜“è¿›å…¥ `PendingOutbound` çŠ¶æ€ï¼ˆç¤ºä¾‹ä¸­ä¸º ZetaChain â†’ Bitcoinï¼Œå³ `7001 â†’ 18332`ï¼‰æ—¶ï¼Œè¯´æ˜å…‘æ¢å·²æˆåŠŸï¼Œ`SwapCompleted` äº‹ä»¶åº”å·²è§¦å‘ã€‚

## æŸ¥è¯¢å­å›¾äº‹ä»¶

è®¿é—®éƒ¨ç½²å­å›¾æ—¶è¾“å‡ºçš„ API åœ°å€ï¼ˆä½ çš„åœ°å€å¯èƒ½ä¸åŒï¼‰ï¼š

```
https://api.goldsky.com/api/public/project_clnujea22c0if34x5965c8c0j/subgraphs/swap-zetachain-testnet/v1/gn
```

é¡µé¢ä¼šæ˜¾ç¤º GraphQL Playgroundï¼Œå¯ç”¨äºæŸ¥è¯¢äº‹ä»¶ï¼š

```graphql
query {
  swapCompleteds(first: 5) {
    id
  }
}
```

ä½ å°†çœ‹åˆ° `SwapCompleted` äº‹ä»¶ ID åˆ—è¡¨ï¼š

```json
{
  "data": {
    "swapCompleteds": [
      {
        "id": "0xbfcc4e8ea59625da42aa3eec6e5aba66bcd120f8e83dea8dc855ebd1d834e1e6-25"
      }
    ]
  }
}
```

è¿˜å¯æŸ¥è¯¢ç‰¹å®šäº‹ä»¶çš„è¯¦ç»†ä¿¡æ¯ï¼š

```graphql
query {
  swapCompleteds(where: { id: "0xbfcc4e8ea59625da42aa3eec6e5aba66bcd120f8e83dea8dc855ebd1d834e1e6-25" }) {
    id
    block_number
    timestamp_
    transactionHash_
    contractId_
    zrc20
    targetToken
    amount
    recipient
  }
}
```

è¿”å›ç»“æœå°†åŒ…å«ä»åˆçº¦äº‹ä»¶ä¸­å‘å‡ºçš„å…¨éƒ¨æ•°æ®ï¼š

```json
{
  "data": {
    "swapCompleteds": [
      {
        "id": "0xbfcc4e8ea59625da42aa3eec6e5aba66bcd120f8e83dea8dc855ebd1d834e1e6-25",
        "block_number": "3065437",
        "timestamp_": "1704357233",
        "transactionHash_": "0xbfcc4e8ea59625da42aa3eec6e5aba66bcd120f8e83dea8dc855ebd1d834e1e6",
        "contractId_": "0x9846bbde15b857d88ddad4e00cd76962245e1b6f",
        "zrc20": "0x48f80608b672dc30dc7e3dbbd0343c5f02c738eb",
        "targetToken": "0x65a45c57636f9bcced4fe193a602008578bca90b",
        "amount": "369767",
        "recipient": "0x74623171326472383564353734353078776465363536307179686a377a767a7739383935687132357478"
      }
    ]
  }
}
```

æ­å–œï¼ä½ å·²é€šè¿‡ Goldsky å­å›¾ç´¢å¼•å™¨æˆåŠŸæŸ¥è¯¢å…¨é“¾åˆçº¦äº‹ä»¶ã€‚æƒ³è¿›ä¸€æ­¥äº†è§£ Goldskyï¼Œè¯·è®¿é—® [Goldsky æ–‡æ¡£](https://docs.goldsky.com/)ã€‚

## å¸¸è§é—®é¢˜

### äº‹ä»¶æœªè¢«ç´¢å¼•

è¯·ç­‰å¾…æ¥è‡ª Goldsky çš„é‚®ä»¶ï¼Œç¡®è®¤å­å›¾å·²å®Œæˆç´¢å¼•ã€‚***

